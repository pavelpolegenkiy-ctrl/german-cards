<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deutsch Тренажёр</title>
    <style>
        /* --- БАЗОВЫЕ СТИЛИ --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b5e20; color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .main-layout { display: flex; gap: 15px; justify-content: center; width: 100%; flex-wrap: wrap; margin-top: 10px; }
        .side-panel, .center-panel { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .side-panel { width: 220px; }
        .center-panel { flex: 1; max-width: 550px; min-width: 320px; }
        .hidden { display: none !important; }
        h1 { text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 10px 0; }
        h3 { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; text-align: center; margin-top: 0; }
        
        /* Счетчик прогресса */
        .progress-counter { background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; color: #a5d6a7; border: 1px solid #43a047; }

        .menu-btn { background-color: #43a047; color: white; border: 2px solid #2e7d32; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .menu-btn:hover { background-color: #2e7d32; transform: translateY(-2px); }
        
        .controls-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }
        .refresh-btn { background-color: #0288d1; border: 2px solid #01579b; flex: 1; }
        .clear-btn { background-color: #e67e22; border: 2px solid #d35400; flex: 1; }
        .hint-btn { background-color: #9b59b6; border: 2px solid #8e44ad; width: 100%; margin-top: 10px; }
        .back-btn { background: #558b2f; color: white; border: 1px solid rgba(255,255,255,0.4); padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }

        .flashcard-scene { width: 100%; height: 280px; perspective: 1000px; cursor: pointer; margin-bottom: 15px; }
        .flashcard-inner { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-inner.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 15px; font-size: 2.5rem; font-weight: bold; text-align: center; padding: 20px; box-sizing: border-box; }
        .flashcard-front { background: white; color: #1b5e20; border: 5px solid #43a047; }
        .flashcard-back { background: #43a047; color: white; transform: rotateY(180deg); border: 5px solid #1b5e20; }
        .audio-btn { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; border-radius: 50%; border: 1px solid #43a047; background: #f1f8e9; cursor: pointer; font-size: 1.5rem; }

        .answer-pool { min-height: 60px; background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; transition: background 0.3s; border: 2px transparent solid; width: 100%; box-sizing: border-box; }
        .answer-pool.correct { background-color: rgba(76, 175, 80, 0.5); border-color: #4CAF50; }
        .answer-pool.wrong { background-color: rgba(244, 67, 54, 0.5); border-color: #F44336; }
        .letter-tile { background: white; color: #1b5e20; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #2e7d32; min-width: 35px; text-align: center; user-select: none; }

        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .game-card { background: white; color: #1b5e20; height: 90px; display: flex; justify-content: center; align-items: center; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.9rem; text-align: center; border: 3px solid #43a047; padding: 5px; }
        .game-card.selected { background: #fff9c4; border-color: #fbc02d; }
        .game-card.matched { visibility: hidden; }
    </style>
</head>
<body>

    <h1>Deutsch Lernen Online</h1>

    <div id="main-ui" class="main-layout">
        <div class="side-panel"><h3>🔥 ТОП-200</h3><div id="left-menu"></div></div>
        <div class="center-panel"><h3>📖 Мои Темы</h3><div id="center-menu"></div></div>
        <div class="side-panel"><h3>🎓 Курс A1</h3><div id="right-menu"></div></div>
    </div>

    <div id="mode-screen" class="center-panel hidden">
        <h2 id="mode-title" style="text-align:center;">Тема</h2>
        <button class="menu-btn" onclick="startGame('flashcards')">📖 Карточки</button>
        <button class="menu-btn" onclick="startGame('match')">🎮 Найди пару</button>
        <button class="menu-btn" onclick="startGame('anagram')">🔠 Анаграммы</button>
        <button class="back-btn" onclick="goHome()">🏠 К списку тем</button>
    </div>

    <div id="game-container" class="center-panel hidden">
        <div class="progress-counter" id="progress-text">Слово: 0 из 0</div>

        <div id="flashcard-area" class="hidden">
            <div class="flashcard-scene" onclick="flipCard()">
                <div class="flashcard-inner" id="flash-card-element">
                    <div class="flashcard-face flashcard-front">
                        <button class="audio-btn" onclick="event.stopPropagation(); speakText()">🔊</button>
                        <span id="flash-text-de"></span>
                    </div>
                    <div class="flashcard-face flashcard-back"><span id="flash-text-ru"></span></div>
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <button class="menu-btn" style="flex:1" onclick="prevCard()">←</button>
                <button class="menu-btn" style="flex:1" onclick="nextCard()">→</button>
            </div>
        </div>

        <div id="match-area" class="hidden">
            <div class="controls-row"><button class="menu-btn refresh-btn" onclick="runMatch()">🔄 Обновить слова</button></div>
            <div id="match-grid" class="grid-container"></div>
        </div>

        <div id="anagram-area" class="hidden" style="display:flex; flex-direction:column; gap:15px; align-items:center;">
            <div class="controls-row">
                <button class="menu-btn refresh-btn" onclick="runAnagram()">🔄 Другое слово</button>
                <button class="menu-btn clear-btn" onclick="clearAnagram()">🧹 Стереть</button>
            </div>
            <div id="anagram-hint" style="font-size:1.8rem; font-weight:bold; color:#a5d6a7;"></div>
            <div id="answer-pool" class="answer-pool"></div>
            <div id="letter-pool" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;"></div>
            <button class="menu-btn hint-btn" onclick="solveAnagram()">💡 Как правильно?</button>
        </div>

        <button class="back-btn" onclick="backToModes()">❌ Выйти в меню</button>
    </div>

    <script src="words.js"></script>
    <script src="words-left.js"></script>
    <script src="words-right.js"></script>

    <script>
        let currentTopic = '';
        let currentWordList = []; // Перемешанный список для текущей сессии
        let currentMode = '';
        let currentCardIndex = 0;
        let selectedCards = [];
        let curAnag;
        let solvedCount = 0; // Для счетчика

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playClickSound() {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.05);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.05);
        }

        function init() {
            renderMenu('left-menu', wordsLeft);
            renderMenu('center-menu', wordCollections);
            renderMenu('right-menu', wordsRight);
        }

        function renderMenu(id, source) {
            const container = document.getElementById(id); container.innerHTML = '';
            Object.keys(source).forEach(key => {
                const btn = document.createElement('button'); btn.className = 'menu-btn'; btn.innerText = key;
                btn.onclick = () => { currentTopic = key; showModes(); };
                container.appendChild(btn);
            });
        }

        function showModes() {
            document.getElementById('main-ui').classList.add('hidden');
            document.getElementById('mode-screen').classList.remove('hidden');
            document.getElementById('mode-title').innerText = currentTopic;
        }

        function startGame(mode) {
            currentMode = mode;
            const all = Object.assign({}, wordCollections, wordsLeft, wordsRight);
            const rawList = all[currentTopic]?.simple || [];
            
            // ПЕРЕМЕШИВАЕМ СПИСОК ПРИ ЗАПУСКЕ
            currentWordList = [...rawList].sort(() => 0.5 - Math.random());
            currentCardIndex = 0;
            solvedCount = 0;

            if (currentWordList.length === 0) return alert("Нет слов!");

            document.getElementById('mode-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            
            updateProgress();
            
            // Скрываем всё
            ['flashcard-area', 'match-area', 'anagram-area'].forEach(a => document.getElementById(a).classList.add('hidden'));

            if(mode === 'flashcards') { document.getElementById('flashcard-area').classList.remove('hidden'); updateCard(); }
            if(mode === 'match') { document.getElementById('match-area').classList.remove('hidden'); runMatch(); }
            if(mode === 'anagram') { document.getElementById('anagram-area').classList.remove('hidden'); runAnagram(); }
        }

        function updateProgress() {
            const total = currentWordList.length;
            const displayIndex = (currentMode === 'flashcards') ? (currentCardIndex + 1) : solvedCount;
            document.getElementById('progress-text').innerText = `Прогресс: ${displayIndex} из ${total}`;
        }

        /* --- КАРТОЧКИ --- */
        function updateCard() {
            const w = currentWordList[currentCardIndex];
            document.getElementById('flash-card-element').classList.remove('is-flipped');
            setTimeout(() => {
                document.getElementById('flash-text-de').innerText = w.de;
                document.getElementById('flash-text-ru').innerText = w.ru;
                updateProgress();
            }, 200);
        }
        function flipCard() { playClickSound(); document.getElementById('flash-card-element').classList.toggle('is-flipped'); }
        function nextCard() { playClickSound(); if(currentCardIndex < currentWordList.length - 1) { currentCardIndex++; updateCard(); } }
        function prevCard() { playClickSound(); if(currentCardIndex > 0) { currentCardIndex--; updateCard(); } }

        /* --- ПАРЫ --- */
        let matchedPairsCount = 0;
        function runMatch() {
            const grid = document.getElementById('match-grid'); grid.innerHTML = '';
            selectedCards = []; matchedPairsCount = 0;
            // Берем порцию из 6 слов (или сколько осталось)
            let list = currentWordList.slice(solvedCount, solvedCount + 6);
            if (list.length === 0) { solvedCount = 0; return runMatch(); } // Рестарт темы

            let cards = [];
            list.forEach(w => { cards.push({id:w.id, t:w.de}, {id:w.id, t:w.ru}); });
            cards.sort(() => 0.5 - Math.random()).forEach(c => {
                const d = document.createElement('div'); d.className = 'game-card'; d.innerText = c.t;
                d.onclick = () => {
                    playClickSound();
                    if(selectedCards.length < 2 && !d.classList.contains('selected')) {
                        d.classList.add('selected'); selectedCards.push({d, id:c.id});
                        if(selectedCards.length === 2) {
                            if(selectedCards[0].id === selectedCards[1].id) {
                                setTimeout(() => { 
                                    selectedCards.forEach(x => x.d.classList.add('matched')); 
                                    selectedCards = []; 
                                    matchedPairsCount++;
                                    if(matchedPairsCount === list.length) {
                                        solvedCount += list.length;
                                        updateProgress();
                                        setTimeout(runMatch, 600);
                                    }
                                }, 400);
                            } else {
                                setTimeout(() => { selectedCards.forEach(x => x.d.classList.remove('selected')); selectedCards = []; }, 800);
                            }
                        }
                    }
                };
                grid.appendChild(d);
            });
            updateProgress();
        }

        /* --- АНАГРАММЫ --- */
        function runAnagram() {
            if (solvedCount >= currentWordList.length) solvedCount = 0; // Зацикливание темы
            curAnag = currentWordList[solvedCount];
            const lp = document.getElementById('letter-pool'); 
            const ap = document.getElementById('answer-pool');
            document.getElementById('anagram-hint').innerText = curAnag.ru;
            lp.innerHTML = ''; ap.innerHTML = '';
            ap.classList.remove('correct', 'wrong');
            
            curAnag.de.split('').sort(() => 0.5 - Math.random()).forEach(l => {
                const tile = document.createElement('div'); tile.className = 'letter-tile'; tile.innerText = l;
                tile.onclick = () => {
                    playClickSound();
                    if(tile.parentElement === lp) ap.appendChild(tile); else lp.appendChild(tile);
                    checkAnagram();
                };
                lp.appendChild(tile);
            });
            updateProgress();
        }

        function clearAnagram() {
            playClickSound();
            const lp = document.getElementById('letter-pool'); const ap = document.getElementById('answer-pool');
            ap.classList.remove('wrong');
            while (ap.firstChild) { lp.appendChild(ap.firstChild); }
        }

        function solveAnagram() {
            playClickSound();
            const ap = document.getElementById('answer-pool'); const lp = document.getElementById('letter-pool');
            ap.innerHTML = ''; lp.innerHTML = '';
            curAnag.de.split('').forEach(char => {
                const tile = document.createElement('div'); tile.className = 'letter-tile'; tile.innerText = char;
                ap.appendChild(tile);
            });
            checkAnagram();
        }

        function checkAnagram() {
            const ap = document.getElementById('answer-pool'); const lp = document.getElementById('letter-pool');
            ap.classList.remove('wrong');
            const currentStr = Array.from(ap.children).map(c => c.innerText).join('');
            if (lp.children.length === 0) {
                if (currentStr === curAnag.de) {
                    ap.classList.add('correct');
                    solvedCount++;
                    const u = new SpeechSynthesisUtterance(curAnag.de); u.lang = 'de-DE'; window.speechSynthesis.speak(u);
                    setTimeout(() => { runAnagram(); }, 1200);
                } else { ap.classList.add('wrong'); }
            }
        }

        function speakText() {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(document.getElementById('flash-text-de').innerText);
            u.lang = 'de-DE'; u.rate = 0.9; window.speechSynthesis.speak(u);
        }

        function goHome() { document.getElementById('mode-screen').classList.add('hidden'); document.getElementById('main-ui').classList.remove('hidden'); }
        function backToModes() { document.getElementById('game-container').classList.add('hidden'); document.getElementById('mode-screen').classList.remove('hidden'); }

        init();
    </script>
</body>
</html>